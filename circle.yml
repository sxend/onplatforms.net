machine:
  services:
    - docker
dependencies:
  pre:
    - nvm install v6.9.1
    - nvm alias default v6.9.1
    - mkdir -p ~/.aws
    - envsubst < .aws/credentials.template > ~/.aws/credentials
    - envsubst < .aws/config.template > ~/.aws/config
  override:
    - sbt "set version := \"b${CIRCLE_BUILD_NUM}-${CIRCLE_SHA1}\"" assembly
    - docker build -t b${CIRCLE_BUILD_NUM}-${CIRCLE_SHA1} -f docker/Dockerfile .
    - docker save -o container.tar b${CIRCLE_BUILD_NUM}-${CIRCLE_SHA1}
    - cd static && npm install && npm run build
deployment:
  publish:
    branch: master
    commands:
      - aws s3 cp ./target/scala-2.11/platform.jar s3://internal-storage.onplatforms.net/zero/jars/b${CIRCLE_BUILD_NUM}-${CIRCLE_SHA1}/
      - aws s3 cp ./container.tar s3://internal-storage.onplatforms.net/zero/containers/b${CIRCLE_BUILD_NUM}-${CIRCLE_SHA1}/
      - cd static && aws s3 sync ./dist/ s3://cdn.onplatforms.net/zero/static/b${CIRCLE_BUILD_NUM}-${CIRCLE_SHA1}/
      - cd static && aws s3 sync ./dist/ s3://cdn.onplatforms.net/zero/static/latest/